<div class="karte account">
    <div class="head left">Account Daten</div>
    <%= form_for(:user, url: dash_user_edit_path(@user)) do |f|%>
    <div class="img-upload">
        <label for="">Nutzerbild</label>
        <label for="user_avatar" style="cursor: pointer; height: 11vh; width: 11vh">
        	<%= image_tag @user.avatar.present? ? @user.avatar.quad.url : '', id: "avatar" %>
        	<input type="file" id="user_avatar" accept='image/*'>
        	<i class="fas fa-plus-circle"></i>
        </label>
    </div>
    <br>
    <div class="fields">
    <div class="half-1">
        <label for="">Firmenname</label>
        <%= f.text_field :company_name, class: 'field' %>
    </div>
    <div class="half-2">
        <label for="">E-Mail</label>
        <% if flash[:email] %>
        <%= f.email_field :email, class: 'field red', value: flash[:email] %>
        <% else %>
        <%= f.email_field :email, class: 'field'%>
        <% end %>
    </div>
    </div>
    <div class="fields">
        <div class="half-1-1">
            <label for="">Vorname</label>
            <%=  f.text_field :fname, class: 'field' %>
        </div>
        <div class="half-1-2">
            <label for="">Nachname</label>
            <%= f.text_field :lname, class: 'field' %>
        </div>
        <% if flash[:password_length] %>
        <div class="half-1-3">
            <label for="">Passwort</label>
            <%= f.password_field :password, placeholder: flash[:password_length], class: 'field red' %>
        </div>
        <div class="half-1-2">
            <label for="">Passwort wdhl</label>
            <%= f.password_field :password_confirmation, placeholder: flash[:password_length], class: 'field red' %>
        </div>
        <% else %>
        <div class="half-1-3">
            <label for="">Passwort</label>
            <%= f.password_field :password, class: 'field' %>
        </div>
        <div class="half-1-2">
            <label for="">Passwort wdhl</label>
            <%= f.password_field :password_confirmation, class: 'field' %>
        </div>
        <% end %>
    </div>
    <%= f.submit 'Ã„nderungen speichern', class: 'btn btn-green' %>
    <% end %>
</div>
<div class="popup" id="popup">
   	<div class="img-container">
   		<%= image_tag '', id: 'user_image' %>
   	</div>
    <div class="form-group center">
    	<div class="btn btn-green" id="crop">speichern</div>
    </div>
    <div class="close" onclick="hidePopup()"><i class="fas fa-times"></i></div>
</div>
<div class="fullscren-blur" id="help-popup">
</div>
<script>
    function showPopup() {
        $('#popup').show();
    }
    function hidePopup() {
        $('#popup').hide();
    }
	(function ($) {
	  $.each(['show', 'hide'], function (i, ev) {
	    var el = $.fn[ev];
	    $.fn[ev] = function () {
	      this.trigger(ev);
	      return el.apply(this, arguments);
	    };
	  });
	})(jQuery);
	var inputAvatar = document.getElementById('user_avatar');
	var image = document.getElementById('user_image');
	
	inputAvatar.addEventListener('change', function(e) {
		var files = e.target.files;
		var done = function(url) {
			inputAvatar.value = '';
			image.src = url;
			$('#popup').show();
		};
		var reader, file, url;
		if(files && files.length > 0) {
			file = files[0];
			if(URL) {
				done(URL.createObjectURL(file));
			} else if(FileReader) {
				reader = new FileReader();
				reader.onload = function(e) {
					done(reader.result);
				}
				reader.readAsDataURL(file);
			}
		}
	})
	$('#popup').on('show', function() {
		cropper = new Cropper(image, {
			aspectRatio: 1,	
		});
	})
	$('#popup').on('hide', function() {
		cropper.destroy();
		cropper = null;
	})
	$('#crop').on('click', function() {
		var initialURL, canvas;
		if(cropper) {
			canvas = cropper.getCroppedCanvas({
				fillColor: "white",
				width: 500,
				height: 500,
			});
			initalURL = avatar.src;
			avatar.src = canvas.toDataURL();
			canvas.toBlob(function(blob) {
				var date = new Date().getTime();
				var file = new window.File([blob], 'avatar_'+date+'.jpg', {type: 'image/jpg'});
				var formData = new FormData();
				formData.append('file', file);
				uploadImage('avatar', formData);
			});
		};
	})
	function uploadImage(img, formData) {
		var url = '<%= dash_user_update_avatar_path() %>';
		$.ajax({
			url: url,
			type: 'put',
			cache: false,
			async: true,
			contentType: false,
			processData: false,
			data: formData,
			beforeSend: function(xhr) { xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content')) },
			success: function(res) {
				formData = new FormData();
				$('#avatar').data('url', res.file);
				$('#sidebar .avatar img').data('url', res.file);
				$('#popup').hide();
			}
		})
		
	}
</script>