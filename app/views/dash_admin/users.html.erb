<section id="gd_users">
  <%= content_for :modal do %>
    <%= render partial: 'form', locals: {u: User.new } %>
  <% end %>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/js/standalone/selectize.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/microplugin/0.0.3/microplugin.js"></script>
<div class="top">

  <div class="select-text">Spielgruppe wählen</div>
    <div class="select">
      <select class="cs-select cs-skin-underline form-field">
        <% if @team %>
          <option value="" disabled selected><%= @team.name %></option>
          <option value="" data-link="<%= dash_admin_users_path %>">Alle Teams</option>
        <% else %>
          <option value="" disabled selected>Alle Teams</option>
          <option value="" data-link="<%= dash_admin_users_path %>" data-class="cs-selected">Alle Teams</option>
        <% end %>
        <% @teams.each do |t| %>
          <% if @team && t.id == @team.id %>
             <option value="<%= t.id %>" data-class="cs-selected"><%= t.name %></option>
          <% else %>
              <option value="<%= t.id %>" data-link="<%= dash_admin_team_users_path(t.id) %>"><%= t.name %></option>
          <% end %>
        <% end %>
    </select>
  </div>

  <button  class="btn-green-plus green-plus-se" id="newUserModal"> 
    <i class='fas fa-plus'></i>
  </button>
  <input type="text" id="searchField" placeholder="Spieler suchen">
  <%= image_tag 'dash/search.png' %>

</div>
   
<div class="users" id="users">
   <div id="table">
    <table id="myTable">
      <thead>
        <tr>
            <th></th>
            <th>Name</th>
            <th>Email</th>
            <th>Unternehmen</th>
            <th>Letztes Spiel</th>
            <th></th>
            <th></th>
        </tr>
      </thead>
      <tbody>
        <% @users.each do |u| %>
        <tr class="user-row">
           <td onclick="redirect_stats(<%= u.teams.first.id if  u.teams.first.present? %>,<%= u.id %>)"><%= u.avatar? ? image_tag(u.avatar.quad.url) : image_tag('defaults/wolf.jpg') %></td>
            <td class="name" onclick="redirect_stats(<%= u.teams.first.id if  u.teams.first.present? %>,<%= u.id %>)"><%= u.fname %> <%= u.lname %></td>
            <td onclick="redirect_stats(<%= u.teams.first.id if  u.teams.first.present? %>,<%= u.id %>)"><%= u.email %></td>
            <td onclick="redirect_stats(<%= u.teams.first.id if  u.teams.first.present? %>,<%= u.id %>)"><%= u.company_name %></td>
            <td onclick="redirect_stats(<%= u.teams.first.id if  u.teams.first.present? %>,<%= u.id %>)"><% if Turn.where(user_id: u.id).count > 0 %><%= Turn.where(user_id: u.id).last.updated_at.strftime('%d.%m.%Y') %><% end %></td>
            <td>
              <div class="btn-group dropleft">
              <a type="button" id="dropdownMenu<%= u.id %>" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-size: 3vh">
                ...
              </a>
              <div class="dropdown-menu" aria-labelledby="dropdownMenu<%= u.id %>">
                <%= link_to 'Löschen!', destroy_user_path(u), class: 'dropdown-item', style: 'border-bottom: none', type: "button", data: { confirm: "Alles Spiele und Statistiken des Nutzers gehen verloren. Bist du sicher, dass du den Nutzer unwideruflich löschen möchtest?" } %>
              </div>
              </div>
            </td>
            <td><% if u.teams.count > 0 %>
                <%= link_to '', dash_admin_user_stats_path(u.teams.first, u), class: "fas fa-chart-line package_pop_up" %>
                <% end %>
            </td>
            <td>
                <a href="#" class="edit-user" data-id="<%=u.id %>"> Edit</a>
            </td>
          </tr>

            <% content_for :modal do%>
                <%= render partial: 'form',locals: { u: u} %>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
  $(".edit-user").on("click", function(e){
    e.preventDefault()
    var $id = $(this).data("id")
    $("#edit-user-modal"+$id).modal("show")

  })
  $("#newUserModal").on("click", function(event){
    event.preventDefault();
    $("#new_user").modal("show");
  });
  $(document).ready(function(){

    $('.InputTags').selectize({
      valueField: 'id',
      plugins: [ 'remove_button'
      ],
      labelField: 'name',
      preload: true,
      create: false,
      allowEmptyOption: true,
      render: {
        option: function(data, escape) {
            return '<option>' +
                    '<span class="url">' + escape(data.name) + '</span>' +
                '</option>';
        },
        item: function(data, escape) {
            return '<span class="tag label label-info">'+escape(data.name)+'<span data-role="remove" class="remove"></span></span>';
        }
      },
      load: function(query, callback) {
        $.get({
            url: '/team_list',
            dataType: 'json',
            data: {
                name: query,
                additionalDataIfRequired: 'Additional Data'
            },
            error: function() {
                callback();
            },
            success: function(res) {
                // you can apply any modification to data before passing it to selectize
                callback(res);
                
            }
          });
        }
      })[0].selectize
      $(".selectize-control").addClass("bootstrap-tagsinput")
      $(".selectize-input.items input").attr("readonly", true);
      // $("").tagsinput()
  })

    function redirect_stats(team, user) {
        <% if @team %>
        window.location.href = "/admins/dash/teams/<%= @team.id %>/users/"+ user +"/stats";
        <% else %>
        window.location.href = "/admins/dash/teams/"+ team +"/users/"+ user +"/stats";
        <% end %>
    }
    $(document).ready( function () {

    $('#myTable').DataTable( {
        "paging":   false,
        "info":     false,
        'searching': false,
        "order": [ 1, 'asc' ],
        "columnDefs": [
            { "orderable": false, "targets": 0 },
            { "orderable": false, "targets": 5 },
            { "orderable": false, "targets": 6 },
        ]
    } );
    
} );
(function() {
				[].slice.call( document.querySelectorAll( 'select.cs-select' ) ).forEach( function(el) {	
					new SelectFx(el);
                    newTab: false;
				} );
			})();
    
var $rows = $('.user-row');
$('#searchField').keyup(function() {
    
    var val = '^(?=.*\\b' + $.trim($(this).val()).split(/\s+/).join('\\b)(?=.*\\b') + ').*$',
        reg = RegExp(val, 'i'),
        text;
    
    $rows.show().filter(function() {
        text = $(this).text().replace(/\s+/g, ' ');
        return !reg.test(text);
    }).hide();
});
new PerfectScrollbar('#table');
new PerfectScrollbar('.cs-options');

            


</script>